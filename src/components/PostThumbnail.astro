---
import { Image } from 'astro:assets';

const { post } = Astro.props;

const gradients = [
    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
    'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)',
    'linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)',
    'linear-gradient(120deg, #f093fb 0%, #f5576c 100%)',
    'linear-gradient(to right, #4facfe 0%, #00f2fe 100%)',
    'linear-gradient(to top, #30cfd0 0%, #330867 100%)',
    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    'linear-gradient(to right, #6a11cb 0%, #2575fc 100%)',
    'linear-gradient(120deg, #89f7fe 0%, #66a6ff 100%)',
    'linear-gradient(to top, #fff1eb 0%, #ace0f9 100%)',
    'linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%)',
    'linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)',
];

function getGradientForTitle(title) {
    let hash = 0;
    for (let i = 0; i < title.length; i++) {
        hash = title.charCodeAt(i) + ((hash << 5) - hash);
    }
    const index = Math.abs(hash) % gradients.length;
    return gradients[index];
}

function getPostImage(post) {
	// 1. Check for explicit heroImage
	if (post.data.heroImage) {
		return { type: 'astro', src: post.data.heroImage };
	}

	// 2. Check for first image in markdown body
	if (post.body) {
		// Match Markdown images: ![alt](url)
		const mdMatch = post.body.match(/!\[.*?\]\((.*?)\)/);
		if (mdMatch && mdMatch[1]) {
			return { type: 'url', src: mdMatch[1] };
		}
		// Match HTML images: <img src="url">
		const htmlMatch = post.body.match(/<img[^>]+src=["'](.*?)["']/);
		if (htmlMatch && htmlMatch[1]) {
			return { type: 'url', src: htmlMatch[1] };
		}
	}

	// 3. Fallback to generated image
	return { 
		type: 'generated', 
		gradient: getGradientForTitle(post.data.title)
	};
}

const thumbnail = getPostImage(post);
---

<div class="post-thumbnail">
	{thumbnail.type === 'astro' ? (
		<Image width={720} height={360} src={thumbnail.src} alt="" class="thumbnail-image" />
	) : thumbnail.type === 'url' ? (
		<img width={720} height={360} src={thumbnail.src} alt="" class="thumbnail-image" />
	) : (
		<div class="placeholder-card" style={`background-image: ${thumbnail.gradient}`}>
			<img src="/dotted_circle.png" class="placeholder-logo" alt="" />
		</div>
	)}
</div>

<style>
	.post-thumbnail {
		width: 100%;
		display: block;
        margin-bottom: 1rem;
	}
	.thumbnail-image {
		width: 100%;
		height: auto;
		aspect-ratio: 2/1;
		object-fit: cover;
		border-radius: 12px;
	}
	.placeholder-card {
		width: 100%;
		aspect-ratio: 2/1;
		border-radius: 12px;
		display: flex;
		align-items: center;
		justify-content: center;
		overflow: hidden;
	}
	.placeholder-logo {
		width: 80px;
		height: 80px;
		opacity: 0.3;
		filter: invert(1) drop-shadow(0 2px 4px rgba(0,0,0,0.1));
		transition: transform 0.3s ease;
	}
	.post-thumbnail:hover .placeholder-logo {
		transform: scale(1.1) rotate(10deg);
		opacity: 0.4;
	}
</style>