---
// Remark42 Comments Component
import type { Lang } from '../i18n/ui';

interface Props {
  lang?: Lang;
}

const { lang = 'zh' } = Astro.props;

// 将语言转换为 Remark42 支持的格式
// zh-CN -> zh, 其他保持不变
const remark42Locale = lang === 'zh-CN' ? 'zh' : lang;
---

<div id="remark42"></div>

<script define:vars={{ remark42Locale }}>
  // Configuration
  const REMARK42_HOST = 'https://remark42.xzos.net';
  const REMARK42_SITE_ID = 'xzos-blog';

  /**
   * 规范化 URL - 移除语言前缀
   * 确保所有语言版本共享同一个评论区
   */
  const getNormalizedUrl = () => {
    const pathname = window.location.pathname;
    // 移除 /en 或 /zh-CN 前缀
    const normalizedPath = pathname.replace(/^\/(en|zh-CN)\//, '/');
    return window.location.origin + normalizedPath;
  };

  // Map blog theme to Remark42 theme
  const getTheme = () => {
    const blogTheme = document.documentElement.dataset.theme || 'solarized';
    return blogTheme === 'tty' ? 'dark' : 'light';
  };

  // Initialize Remark42
  window.remark_config = {
    host: REMARK42_HOST,
    site_id: REMARK42_SITE_ID,
    components: ['embed'],
    url: getNormalizedUrl(),           // 使用规范化 URL
    theme: getTheme(),
    locale: remark42Locale,            // 使用页面语言
  };

  // Load Remark42 script
  (function(c) {
    for(var i = 0; i < c.length; i++){
      var d = document, s = d.createElement('script');
      s.src = window.remark_config.host + '/web/' + c[i] + '.js';
      s.defer = true;
      (d.head || d.body).appendChild(s);
    }
  })(window.remark_config.components || ['embed']);

  // Listen for theme changes
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.attributeName === 'data-theme') {
        const newTheme = getTheme();
        if (window.REMARK42) {
          window.REMARK42.changeTheme(newTheme);
        }
      }
    });
  });

  // Start observing theme changes
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme']
  });
</script>

<style>
  #remark42 {
    max-width: 100%;
    margin: 2rem auto;
  }
</style>
